name: Infrastructure CI (Hyper-V + Ansible)

on:
  push:
    branches: [ main ]

concurrency:
  group: infra-ci
  cancel-in-progress: false

jobs:
  preflight:
    name: Preflight checks (Runner sanity)
    runs-on: self-hosted
    outputs:
      hyperv: ${{ steps.hyperv.outputs.enabled }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Check Hyper-V availability
        id: hyperv
        shell: pwsh
        run: |
          $feature = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
          if ($feature.State -ne "Enabled") {
            Write-Host "::warning::Hyper-V is NOT enabled on this runner."
            echo "enabled=false" >> $env:GITHUB_OUTPUT
          } else {
            echo "enabled=true" >> $env:GITHUB_OUTPUT
          }

      - name: Check WSL & Fedora
        shell: pwsh
        run: |
          wsl --status
          wsl -d Fedora -- uname -a

  provision:
    name: Provision VM (real infra)
    needs: preflight
    if: needs.preflight.outputs.hyperv == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Inject SSH secrets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force powershell/secrets
          Set-Content powershell/secrets/deploy_key "${{ secrets.DEPLOY_KEY }}"
          Set-Content powershell/secrets/deploy_key.pub "${{ secrets.DEPLOY_KEY_PUB }}"
          icacls powershell/secrets/deploy_key /inheritance:r /grant:r "$($env:USERNAME):(R)"

      - name: Create VM via Hyper-V
        shell: pwsh
        run: |
          ./powershell/Create-VM.ps1 -NonInteractive -CI

  configure:
    name: Configure VM (Ansible via WSL)
    needs: provision
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Run Ansible playbooks
        shell: pwsh
        run: |
          wsl -d Fedora -- ansible-playbook playbooks/install_zabbix_server.yml

  smoke-tests:
    name: Smoke tests (infra reality check)
    needs: configure
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Validate VM is reachable
        shell: pwsh
        run: |
          ./powershell/utils/common.ps1
          Test-Connection -ComputerName (Get-VM | Select-Object -First 1).Name -Count 2

      - name: Check Zabbix service
        shell: pwsh
        run: |
          wsl -d Fedora -- curl -f http://localhost/zabbix || exit 1

  teardown:
    name: Teardown (always clean)
    if: always()
    needs: [provision, configure, smoke-tests]
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Remove VM safely
        shell: pwsh
        run: |
          ./powershell/Remove-VM.ps1 -CI -Force
