name: Infrastructure CI/CD & State Sync

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-sync:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate PowerShell Syntax
        shell: powershell
        run: |
          $scripts = Get-ChildItem -Recurse -Include *.ps1, *.psm1
          foreach ($file in $scripts) {
              Write-Host "Checking: $($file.FullName)"
              $parseError = $null
              # Usamos [ref]$parseError en lugar de [ref]$error
              [void][System.Management.Automation.Language.Parser]::ParseFile($file.FullName, [ref]$null, [ref]$parseError)
              if ($parseError) {
                  Write-Error "Syntax error in $($file.Name): $($parseError.Message)"
                  exit 1
              }
          }

      - name: Validate Ansible Syntax (via WSL)
        run: |
          wsl ansible-playbook playbooks/setup_zabbix_host.yml --syntax-check

      - name: Verify State Integrity
        shell: powershell
        run: |
          if (-not (Test-Path "fake_db.yml")) {
              Write-Error "Critical Error: fake_db.yml is missing!"
              exit 1
          }
      
      - name: Deploy Zabbix Core Infrastructure
        shell: powershell
        run: |
          ./powershell/Create-VM.ps1 -VMName "Zabbix-Server" -Size "Large" -Role "Server"
          
      - name: Install Zabbix Server via Ansible
        run: |
          wsl ansible-playbook playbooks/install_zabbix_server.yml -e "target=Zabbix-Server"

      - name: Execute VM Provisioning (Zabbix Nodes)
        shell: powershell
        run: |
          # Vi anropar Create-VM med parametrar för de olika rollerna
          # Här skapas agenter/noder som ska övervakas
          ./powershell/Create-VM.ps1 -VMName "Zabbix-Agent-Web" -Size "Small"
          ./powershell/Create-VM.ps1 -VMName "Zabbix-Agent-DB" -Size "Large"
          
      - name: Run Ansible Configuration
        run: |
          # Efter att VM skapats körs konfigurationen via WSL
          wsl ansible-playbook playbooks/setup_zabbix_host.yml