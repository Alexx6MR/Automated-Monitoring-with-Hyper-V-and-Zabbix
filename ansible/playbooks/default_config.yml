---
# 1. Configuración de Idioma (Simplificada para evitar bloqueos)
- name: Install Swedish language pack
  ansible.builtin.dnf: # Usamos dnf directamente que es más rápido en AlmaLinux
    name: glibc-langpack-sv
    state: present

- name: Set system locale and keyboard
  ansible.builtin.shell: |
    localectl set-locale LANG=sv_SE.UTF-8
    localectl set-x11-keymap se
  changed_when: false

# 2. Actualización y Herramientas (Agrupado para una sola transacción DNF)
- name: Install base administration tools
  ansible.builtin.dnf:
    name:
      - vim
      - wget
      - curl
      - net-tools
      - git
      - firewalld
      - python3-firewall
    state: present

# 3. Seguridad: Firewall
- name: Ensure firewalld is running
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: true

- name: Allow services in firewall
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - ssh
    - http
    - https
    - mysql

# 4. Configuración de /etc/hosts
- name: Ensure localhost is mapped correctly
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1'
    line: "127.0.0.1 localhost localhost.localdomain"
    state: present

# 5. Red (ELIMINADO EL REINICIO DE CONEXIÓN)
- name: Configure persistent DHCP identity
  community.general.nmcli:
    conn_name: "eth0"
    ifname: "eth0"
    type: ethernet
    dhcp_client_id: "{{ ansible_hostname }}"
    state: present
  # No reiniciamos la conexión aquí. El cambio se aplicará solo
  # en el próximo reboot o cuando sea estrictamente necesario,
  # evitando que Ansible se quede "colgado" esperando el SSH.