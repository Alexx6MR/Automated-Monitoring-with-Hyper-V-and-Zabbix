---
# 1. Language Configuration (Simplified to avoid lockouts)
- name: Install Swedish language pack
  ansible.builtin.dnf: # Using dnf directly as it is faster on AlmaLinux
    name: glibc-langpack-sv
    state: present

- name: Set system locale and keyboard
  ansible.builtin.shell: |
    localectl set-locale LANG=sv_SE.UTF-8
    localectl set-x11-keymap se
  changed_when: false

# 2. Updates and Tools (Grouped into a single DNF transaction)
- name: Install base administration tools
  ansible.builtin.dnf:
    name:
      - vim
      - wget
      - curl
      - net-tools
      - git
      - firewalld
      - python3-firewall
    state: present

# 3. Security: Firewall
- name: Ensure firewalld is running
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: true

- name: Allow services in firewall
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - ssh
    - http
    - https
    - mysql

# 4. /etc/hosts Configuration
- name: Ensure localhost is mapped correctly
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1'
    line: "127.0.0.1 localhost localhost.localdomain"
    state: present

# 5. Network (CONNECTION RESTART REMOVED)
- name: Configure persistent DHCP identity
  community.general.nmcli:
    conn_name: "eth0"
    ifname: "eth0"
    type: ethernet
    dhcp_client_id: "{{ ansible_hostname }}"
    state: present
  # We do not restart the connection here. The change will apply
  # on the next reboot or when strictly necessary, preventing 
  # Ansible from hanging while waiting for SSH.