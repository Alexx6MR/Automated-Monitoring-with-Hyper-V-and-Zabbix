---
- name: Deploy Zabbix Agents
  hosts: "{{ target_hosts | default('all') }}"
  serial: 1
  become: yes

  vars_files:
    - "../fake_db.yml"  # <--- PRIORIDAD ALTA: Ansible buscará zabbix_server_ip aquí

  vars:
    ansible_user: deploy
    ansible_ssh_private_key_file: "~/.ssh/deploy_key"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    # Borramos el lookup de aquí para evitar conflictos
    repo_rpm_url: "https://repo.zabbix.com/zabbix/7.0/alma/9/x86_64/zabbix-release-latest.el9.noarch.rpm"

  handlers:
    - name: restart zabbix-agent
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: restarted

  tasks:
    # 1. Ejecuta la configuración de Suecia, herramientas y firewall base
    - name: Ensure Base configuration is installed
      ansible.builtin.include_tasks: default_config.yml

    - name: Validate Zabbix Server IP presence
      ansible.builtin.assert:
        that:
          - zabbix_server_ip is defined
          - zabbix_server_ip | length > 0
        fail_msg: "CRITICAL ERROR: 'zabbix_server_ip' is missing. Check your fake_db.yml file."
        success_msg: "Zabbix Server IP validated: {{ zabbix_server_ip }}"

    - name: Debug IP from Fake DB
      ansible.builtin.debug:
        msg: "The server IP is: {{ zabbix_server_ip }}"

    - name: Install Zabbix Official Repository
      ansible.builtin.dnf:
        name: "{{ repo_rpm_url }}"
        state: present
        disable_gpg_check: true

    - name: Install Zabbix Agent 2 and Firewalld
      ansible.builtin.dnf:
        name: 
          - zabbix-agent2
          - firewalld
          - python3-firewall
        state: present

    - name: Configure Zabbix Agent 2 (Fix Identity)
      ansible.builtin.lineinfile:
        path: /etc/zabbix/zabbix_agent2.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^Server=', line: "Server={{ zabbix_server_ip }}" }
        - { regexp: '^ServerActive=', line: "ServerActive={{ zabbix_server_ip }}" }
        - { regexp: '^Hostname=', line: "Hostname={{ ansible_facts['hostname'] }}" }
        - { regexp: '^#? ?HostMetadata=', line: "HostMetadata=type:zabbix_node_sw,env:lab,os:linux" }
        - { regexp: '^#? ?RefreshActiveChecks=', line: "RefreshActiveChecks=60" }
      notify: restart zabbix-agent

    - name: Ensure firewalld is running
      ansible.builtin.systemd:
        name: firewalld
        state: started
        enabled: true

    - name: Allow Zabbix Agent through Firewall
      ansible.posix.firewalld:
        port: 10050/tcp
        permanent: true
        state: enabled
        immediate: true

    - name: Ensure Zabbix Agent 2 is started and enabled
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: started
        enabled: true

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Install Zabbix Sender
      ansible.builtin.dnf:
        name: zabbix-sender
        state: present
    
    - name: Force immediate Active Check registration
      ansible.builtin.shell: >
        zabbix_sender -z {{ zabbix_server_ip }} 
        -s "{{ inventory_hostname }}" 
        -k "agent.ping" 
        -o 1
      register: sender_result
      # Usamos ignore_errors o failed_when porque a veces el primer saludo 
      # falla si el servidor aún no ha procesado el autoregistro.
      failed_when: false

    - name: Restart Zabbix Agent 2 to refresh active checks
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: restarted